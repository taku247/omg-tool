# アービトラージBot アーキテクチャ設計書

## 概要

本ドキュメントは、Hyperliquid（DEX）と複数CEX（Bybit、Bitget、Gate.io、KuCoin）間の価格乖離を利用した両建てアービトラージBotのアーキテクチャ設計を記述します。

## システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                     Arbitrage Bot System                      │
├─────────────────────────────────────────────────────────────┤
│                     Strategy Engine                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Arbitrage   │  │   Position   │  │    Risk      │      │
│  │  Detector    │  │   Manager    │  │   Manager    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
├─────────────────────────────────────────────────────────────┤
│                    Trading Layer                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │Order Manager │  │   Balance    │  │  Transaction │      │
│  │              │  │   Tracker    │  │    Logger    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
├─────────────────────────────────────────────────────────────┤
│                   Exchange Abstraction                        │
│  ┌───────────────────────────────────────────────────┐      │
│  │          Unified Exchange Interface               │      │
│  ├─────────┬─────────┬─────────┬─────────┬─────────┤      │
│  │Hyperliquid│ Bybit │ Bitget │ Gate.io │ KuCoin  │      │
│  └─────────┴─────────┴─────────┴─────────┴─────────┘      │
├─────────────────────────────────────────────────────────────┤
│                  Data Collection Layer                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  WebSocket   │  │  REST API    │  │  OrderBook   │      │
│  │   Manager    │  │   Client     │  │   Cache      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## モジュール構成

### 1. データ収集層 (Data Collection Layer)

- **WebSocket Manager**: 各取引所のWebSocket接続を管理し、リアルタイムデータを収集
- **REST API Client**: 補助的なデータ取得や注文実行に使用
- **OrderBook Cache**: 板情報をメモリにキャッシュし、高速アクセスを実現

### 2. 取引所抽象化層 (Exchange Abstraction)

- **Unified Exchange Interface**: 全取引所を統一的に扱うためのインターフェース
- **Exchange Adapters**: 各取引所固有のAPI仕様を統一インターフェースに変換

### 3. 取引実行層 (Trading Layer)

- **Order Manager**: 注文の実行、追跡、管理を担当
- **Balance Tracker**: 各取引所の残高をリアルタイムで追跡
- **Transaction Logger**: 全取引の詳細なログを記録

### 4. 戦略エンジン (Strategy Engine)

- **Arbitrage Detector**: 価格乖離を検出し、取引機会を特定
- **Position Manager**: ポジションの開閉と管理
- **Risk Manager**: リスク評価と取引承認

## 主要なデータフロー

1. **価格データ収集**
   - WebSocket経由でリアルタイムティッカーデータを受信
   - データをキャッシュに保存し、Arbitrage Detectorに通知

2. **アービトラージ検出**
   - 複数取引所の価格を比較
   - 閾値を超える乖離を検出したら取引機会として記録

3. **取引実行**
   - Risk Managerで取引可否を判定
   - Order Managerで両建て注文を同時実行
   - Position Managerでポジションを追跡

4. **ポジション管理**
   - 乖離が収束したタイミングでポジションをクローズ
   - 損益を計算し、Transaction Loggerに記録

## 技術スタック

### Python実装
- **非同期処理**: asyncio
- **WebSocket**: websockets, aiohttp
- **データ処理**: pandas, numpy
- **ログ**: structlog
- **設定管理**: pydantic

### Rust実装（将来）
- **非同期ランタイム**: tokio
- **WebSocket**: tungstenite
- **シリアライゼーション**: serde
- **ログ**: tracing

## パフォーマンス考慮事項

1. **レイテンシ最小化**
   - WebSocket接続の永続化
   - メモリキャッシュの活用
   - 非同期並行処理

2. **スケーラビリティ**
   - 取引所と通貨ペアの動的追加
   - 水平スケーリング対応設計

3. **信頼性**
   - 自動再接続機能
   - エラーハンドリングとリトライ
   - トランザクションの原子性保証

## セキュリティ考慮事項

1. **API資格情報管理**
   - 環境変数での管理
   - 暗号化された設定ファイル

2. **取引制限**
   - レート制限の遵守
   - ポジションサイズ制限

3. **監査ログ**
   - 全取引の完全な記録
   - 異常検知アラート